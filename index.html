<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deevo Dynasty Mission Tracker</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set default font */
        body { font-family: 'Inter', sans-serif; }
        /* Style for the scrollbar within the mission list */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #f3f4f6; }
    </style>

    <!-- Load React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is required to process the JSX/ES6 in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Firebase CDNs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <!-- Load Lucide Icons CDN for visual appeal -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root">
        <!-- React App mounts here -->
        <div class="flex justify-center items-center h-screen bg-gray-50">
            <div class="text-2xl font-semibold text-indigo-600">Initializing Application...</div>
        </div>
    </div>

    <!-- The React component logic -->
    <script type="text/babel">
        // Import necessary components from the global Firebase and Lucide objects
        const { useState, useEffect, useCallback, useMemo } = React;
        const { initializeApp } = firebase.app;
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth;
        const { 
            getFirestore, 
            doc, 
            onSnapshot, 
            collection, 
            query, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            setLogLevel
        } = firebase.firestore;
        
        // Lucide Icons (from the global Lucide object)
        const { Zap, Users, Shield, Plus, Check, Trash2, Globe, Lock, Clock } = lucide;

        // Set Firebase logging level to help with debugging in the console
        setLogLevel('debug');

        // --- Component: MissionItem ---
        const MissionItem = ({ mission, userId, db, isPrivate }) => {
            const handleToggleComplete = useCallback(async () => {
                if (!userId || !db) return;

                const collectionPath = isPrivate 
                    ? `artifacts/${mission.appId}/users/${userId}/missions`
                    : `artifacts/${mission.appId}/public/data/missions`;
                    
                try {
                    const docRef = doc(db, collectionPath, mission.id);
                    await updateDoc(docRef, {
                        completed: !mission.completed,
                        // Only set completion time if it was just completed
                        completedAt: !mission.completed ? new Date() : null
                    });
                } catch (error) {
                    console.error("Error toggling mission completion:", error);
                    // Use a simple, non-blocking modal/alert-like log if needed
                    // alert("Failed to update mission status. Check console for details.");
                }
            }, [mission.id, mission.completed, userId, db, mission.appId, isPrivate]);

            const handleDelete = useCallback(async () => {
                if (!userId || !db) return;

                const collectionPath = isPrivate 
                    ? `artifacts/${mission.appId}/users/${userId}/missions`
                    : `artifacts/${mission.appId}/public/data/missions`;

                // Safety check: Only the owner (or user for private) can delete
                if (!isPrivate && mission.userId !== userId) {
                    console.warn("Attempted to delete a public mission without ownership.");
                    return;
                }

                // IMPORTANT: Since alert/confirm is forbidden, this is a conceptual confirmation step.
                // In a real app, this would be a custom modal. We'll proceed directly for simplicity here.
                const shouldDelete = window.confirm("Are you sure you want to delete this mission?"); // Temporary use of confirm for functionality verification
                
                if (shouldDelete) {
                    try {
                        const docRef = doc(db, collectionPath, mission.id);
                        await deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error deleting mission:", error);
                    }
                }
            }, [mission.id, userId, db, mission.appId, mission.userId, isPrivate]);

            const isOwner = mission.userId === userId;
            const isCompleted = mission.completed;
            
            // Formatting the date
            const formattedCompletedDate = useMemo(() => {
                if (!isCompleted || !mission.completedAt) return null;
                // Check if completedAt is a Firebase Timestamp, convert it to Date object
                const date = mission.completedAt.toDate ? mission.completedAt.toDate() : (mission.completedAt instanceof Date ? mission.completedAt : null);
                return date ? date.toLocaleDateString() : null;
            }, [isCompleted, mission.completedAt]);

            const missionStatusClasses = isCompleted 
                ? 'bg-green-100 text-green-800 border-green-400' 
                : 'bg-white text-gray-800 border-gray-200 hover:bg-gray-50';

            return (
                <div className={`p-4 mb-3 rounded-xl shadow-lg flex items-center transition duration-200 ease-in-out ${missionStatusClasses}`}>
                    {/* Completion Button/Status */}
                    <button
                        onClick={handleToggleComplete}
                        className={`w-8 h-8 rounded-full flex items-center justify-center mr-4 transition duration-300 ${isCompleted ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-500 hover:bg-green-500 hover:text-white'}`}
                        title={isCompleted ? "Mark as Incomplete" : "Mark as Complete"}
                    >
                        <Check className="w-5 h-5" />
                    </button>

                    {/* Mission Details */}
                    <div className="flex-grow min-w-0">
                        <p className={`font-semibold text-lg break-words ${isCompleted ? 'line-through opacity-70' : ''}`}>
                            {mission.description}
                        </p>
                        <div className="flex items-center text-sm text-gray-500 mt-1">
                            <Zap className="w-4 h-4 mr-1 text-yellow-600" />
                            <span>{mission.points} Points</span>
                            {mission.userId && (
                                <span className="ml-3 flex items-center" title={`Owner ID: ${mission.userId}`}>
                                    <Users className="w-4 h-4 mr-1" />
                                    {mission.userId.substring(0, 8)}...
                                </span>
                            )}
                            {isCompleted && formattedCompletedDate && (
                                <span className="ml-3 flex items-center" title={`Completed On: ${formattedCompletedDate}`}>
                                    <Clock className="w-4 h-4 mr-1" />
                                    {formattedCompletedDate}
                                </span>
                            )}
                        </div>
                    </div>

                    {/* Delete Button (Only visible to owner or for private missions) */}
                    {(isPrivate || isOwner) && (
                        <button
                            onClick={handleDelete}
                            className="ml-4 p-2 rounded-full text-red-500 bg-red-100 hover:bg-red-500 hover:text-white transition duration-200"
                            title="Delete Mission"
                        >
                            <Trash2 className="w-5 h-5" />
                        </button>
                    )}
                </div>
            );
        };

        // --- Component: MissionList ---
        const MissionList = ({ title, missions, userId, db, isPrivate, icon: Icon, points }) => (
            <div className="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 mb-8">
                <div className="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 className="text-2xl font-bold text-gray-700 flex items-center">
                        <Icon className="w-6 h-6 mr-2 text-indigo-500" />
                        {title}
                    </h2>
                    <div className="flex items-center text-xl font-extrabold text-yellow-600 bg-yellow-100 px-4 py-1 rounded-full shadow-inner">
                        <Zap className="w-5 h-5 mr-1" />
                        {points}
                    </div>
                </div>
                
                <div className="custom-scrollbar min-h-[100px] max-h-[400px] overflow-y-auto pr-2">
                    {missions.length === 0 ? (
                        <p className="text-gray-500 text-center py-6">
                            {isPrivate ? "No private missions found. Start by adding one below!" : "No public missions found. Be the first to post one!"}
                        </p>
                    ) : (
                        missions.map(mission => (
                            <MissionItem
                                key={mission.id}
                                mission={mission}
                                userId={userId}
                                db={db}
                                isPrivate={isPrivate}
                            />
                        ))
                    )}
                </div>
            </div>
        );

        // --- Component: MissionForm ---
        const MissionForm = ({ userId, db, appId, isPublic, onAddMission }) => {
            const [description, setDescription] = useState('');
            const [points, setPoints] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                setError('');

                if (!description || !points) {
                    setError('Please enter both a description and points.');
                    return;
                }

                const numericPoints = parseInt(points, 10);
                if (isNaN(numericPoints) || numericPoints <= 0) {
                    setError('Points must be a positive number.');
                    return;
                }

                if (!userId || !db || !appId) {
                    setError('System error: User or database connection not ready.');
                    console.error("Form submit failed: userId, db, or appId is missing.", { userId, db, appId });
                    return;
                }
                
                // Define the collection path based on the selected type
                const collectionPath = isPublic 
                    ? `artifacts/${appId}/public/data/missions` 
                    : `artifacts/${appId}/users/${userId}/missions`;

                try {
                    await addDoc(collection(db, collectionPath), {
                        description: description,
                        points: numericPoints,
                        userId: userId, // Store the user ID for ownership checks
                        completed: false,
                        createdAt: new Date(),
                        appId: appId
                    });

                    setDescription('');
                    setPoints('');
                    onAddMission(); // Call callback to switch tab if public
                } catch (err) {
                    console.error("Error adding mission:", err);
                    // Display a user-friendly message based on the error type
                    if (err.message.includes('permission denied')) {
                        setError('Error: Permission Denied. Check Firestore Security Rules!');
                    } else {
                        setError(`Failed to add mission: ${err.message.substring(0, 50)}...`);
                    }
                }
            }, [description, points, userId, db, appId, isPublic, onAddMission]);

            return (
                <form onSubmit={handleSubmit} className="p-6 bg-white rounded-2xl shadow-2xl border border-indigo-100 mt-8">
                    <h3 className="text-xl font-bold mb-4 text-indigo-700">Add New {isPublic ? 'Public' : 'Private'} Mission</h3>
                    
                    <div className="flex flex-col md:flex-row gap-4 mb-4">
                        <input
                            type="text"
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            placeholder="Enter mission description..."
                            className="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                            required
                        />
                        <input
                            type="number"
                            value={points}
                            onChange={(e) => setPoints(e.target.value)}
                            placeholder="Points"
                            className="w-full md:w-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                            required
                        />
                    </div>

                    {error && (
                        <p className="text-red-600 bg-red-100 p-2 rounded-lg mb-4 text-center border border-red-300 font-medium">
                            {error}
                        </p>
                    )}

                    <button
                        type="submit"
                        className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center"
                    >
                        <Plus className="w-5 h-5 mr-2" />
                        Add {isPublic ? 'Public' : 'Private'} Mission
                    </button>
                </form>
            );
        };


        // --- Main Component: App ---
        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [appId, setAppId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [tab, setTab] = useState('private'); // 'private' or 'public'

            const [privateMissions, setPrivateMissions] = useState([]);
            const [publicMissions, setPublicMissions] = useState([]);

            // --- Core Firebase Initialization and Authentication ---
            useEffect(() => {
                try {
                    // 1. Safely retrieve global variables
                    // Note: __app_id, __firebase_config, and __initial_auth_token are provided by the environment
                    const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    let firebaseConfig;
                    try {
                        firebaseConfig = JSON.parse(firebaseConfigString);
                        if (Object.keys(firebaseConfig).length === 0) {
                             throw new Error("Parsed Firebase config is empty.");
                        }
                    } catch (e) {
                         throw new Error(`Invalid Firebase config: ${e.message}`);
                    }
                    
                    setAppId(currentAppId);
                    
                    // 2. Initialize Firebase App and Services
                    const app = initializeApp(firebaseConfig);
                    const firestoreDb = getFirestore(app);
                    const firebaseAuth = getAuth(app);
                    
                    setDb(firestoreDb);
                    setAuth(firebaseAuth);

                    // 3. Handle Authentication
                    const handleAuth = async () => {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(firebaseAuth, initialAuthToken);
                            } else {
                                await signInAnonymously(firebaseAuth);
                            }
                        } catch (authError) {
                            console.error("Authentication Error:", authError);
                            // If sign-in fails, we still try to proceed, but the user ID will be null initially.
                        }
                    };
                    handleAuth();

                    // 4. Set up Auth State Listener
                    const unsubscribeAuth = onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            console.log("User authenticated. UID:", user.uid);
                        } else {
                            // If the user is still null, generate a random ID for anonymous identification
                            const anonId = 'anon-' + (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2, 15));
                            setUserId(anonId);
                            console.log("User signed out or anonymous sign-in failed. Using anonymous ID:", anonId);
                        }
                        setLoading(false);
                    });
                    
                    return () => {
                        unsubscribeAuth();
                    };

                } catch (err) {
                    console.error("Firebase Initialization Error:", err);
                    setError("Initialization Failed. Check the Console for details.");
                    setLoading(false);
                }
            }, []); // Run only once on mount

            // --- Firestore Data Listeners ---
            useEffect(() => {
                // Only run listeners once Firebase services and user ID/appId are ready
                if (!db || !userId || !appId) {
                    return;
                }

                // 1. Listener for Private Missions: /artifacts/{appId}/users/{userId}/missions
                const privateCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/missions`);
                const qPrivate = query(privateCollectionRef);

                const unsubscribePrivate = onSnapshot(qPrivate, (snapshot) => {
                    const missions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        appId: appId // Ensure mission objects contain the appId for doc path
                    }));
                    setPrivateMissions(missions);
                    console.log("Private missions updated.");
                }, (err) => {
                    console.error("Private Mission Listener Error:", err);
                    if (err.code === 'permission-denied') {
                        console.error("FIREBASE PERMISSION DENIED: Check your Firestore Security Rules for private data paths.");
                    }
                });

                // 2. Listener for Public Missions: /artifacts/{appId}/public/data/missions
                const publicCollectionRef = collection(db, `artifacts/${appId}/public/data/missions`);
                const qPublic = query(publicCollectionRef);

                const unsubscribePublic = onSnapshot(qPublic, (snapshot) => {
                    const missions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        appId: appId // Ensure mission objects contain the appId for doc path
                    }));
                    setPublicMissions(missions);
                    console.log("Public missions updated.");
                }, (err) => {
                    console.error("Public Mission Listener Error:", err);
                    if (err.code === 'permission-denied') {
                        console.error("FIREBASE PERMISSION DENIED: Check your Firestore Security Rules for public data paths.");
                    }
                });


                // Cleanup function for listeners
                return () => {
                    unsubscribePrivate();
                    unsubscribePublic();
                };

            }, [db, userId, appId]); // Rerun when services or userId/appId change

            // --- Calculations ---
            const calculatePoints = (missions) => {
                return missions
                    .filter(m => m.completed)
                    .reduce((sum, m) => sum + m.points, 0);
            };

            const privatePoints = useMemo(() => calculatePoints(privateMissions), [privateMissions]);
            const publicPoints = useMemo(() => calculatePoints(publicMissions), [publicMissions]);
            const totalPoints = privatePoints + publicPoints;

            const handleAddPublicMission = useCallback(() => {
                // Switch to public tab after adding a public mission
                setTab('public');
            }, []);

            // --- Render Logic ---
            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen bg-gray-50">
                        <div className="text-2xl font-semibold text-indigo-600">Loading Tracker...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-red-100 p-8 rounded-xl">
                        <h1 className="text-3xl font-bold text-red-700 mb-4">Application Error</h1>
                        <p className="text-xl text-red-600 mb-6">{error}</p>
                        <p className="text-gray-700 text-center">
                            Please check the browser console (F12) for detailed initialization errors. This often means the Firebase configuration is missing or invalid.
                        </p>
                    </div>
                );
            }
            
            // Safety check if auth failed but loading completed
            if (!userId) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-yellow-100 p-8 rounded-xl">
                        <h1 className="text-3xl font-bold text-yellow-700 mb-4">Authentication Failed</h1>
                        <p className="text-xl text-yellow-600 mb-6">Could not establish a user session. Please refresh or check console.</p>
                    </div>
                )
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
                    <header className="text-center mb-10">
                        <h1 className="text-4xl sm:text-5xl font-extrabold text-indigo-800 tracking-tight">
                            <span className="text-yellow-500">Deevo</span> Dynasty Tracker
                        </h1>
                        <p className="text-lg text-gray-500 mt-2">Track your progress and collaborate on missions.</p>
                        <div className="mt-4 p-3 bg-indigo-50 rounded-xl inline-block shadow-inner">
                            <p className="text-sm font-medium text-indigo-700">
                                Your User ID: <span className="font-mono text-xs break-all ml-1 bg-indigo-200 px-2 py-1 rounded">{userId}</span>
                            </p>
                        </div>
                    </header>

                    {/* Total Points Display */}
                    <div className="max-w-4xl mx-auto bg-indigo-600 p-6 rounded-2xl shadow-2xl mb-10">
                        <h2 className="text-2xl font-bold text-white mb-2 flex items-center justify-center">
                            <Zap className="w-6 h-6 mr-2 text-yellow-300 animate-pulse" />
                            TOTAL DYNASTY POINTS
                        </h2>
                        <p className="text-6xl font-extrabold text-center text-yellow-300">
                            {totalPoints}
                        </p>
                    </div>

                    {/* Tabs for Mission Lists */}
                    <div className="max-w-4xl mx-auto mb-6 flex space-x-4">
                        <button
                            onClick={() => setTab('private')}
                            className={`flex-1 flex items-center justify-center py-3 rounded-xl font-semibold transition duration-300 ${
                                tab === 'private' 
                                    ? 'bg-indigo-600 text-white shadow-xl' 
                                    : 'bg-white text-indigo-600 hover:bg-indigo-100 border border-indigo-200'
                            }`}
                        >
                            <Lock className="w-5 h-5 mr-2" />
                            Your Private Missions
                        </button>
                        <button
                            onClick={() => setTab('public')}
                            className={`flex-1 flex items-center justify-center py-3 rounded-xl font-semibold transition duration-300 ${
                                tab === 'public' 
                                    ? 'bg-indigo-600 text-white shadow-xl' 
                                    : 'bg-white text-indigo-600 hover:bg-indigo-100 border border-indigo-200'
                            }`}
                        >
                            <Globe className="w-5 h-5 mr-2" />
                            Public Shared Missions
                        </button>
                    </div>

                    {/* Mission Lists */}
                    <div className="max-w-4xl mx-auto">
                        {tab === 'private' && (
                            <MissionList 
                                title="Private Missions" 
                                missions={privateMissions} 
                                userId={userId}
                                db={db}
                                isPrivate={true}
                                icon={Shield}
                                points={privatePoints}
                            />
                        )}
                        {tab === 'public' && (
                            <MissionList 
                                title="Public Missions" 
                                missions={publicMissions} 
                                userId={userId}
                                db={db}
                                isPrivate={false} // Important: this is false for public
                                icon={Users}
                                points={publicPoints}
                            />
                        )}
                    </div>

                    {/* Mission Creation Form */}
                    <div className="max-w-4xl mx-auto">
                        <MissionForm 
                            userId={userId} 
                            db={db} 
                            appId={appId} 
                            isPublic={tab === 'public'} 
                            onAddMission={handleAddPublicMission}
                        />
                    </div>
                    
                </div>
            );
        };

        // Render the App component to the root div
        const domNode = document.getElementById('root');
        const root = ReactDOM.createRoot(domNode);
        root.render(<App />);

    </script>
</body>
</html>
