<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deevo Dynasty Code Tracker</title>

    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Set default font */
        body { font-family: 'Inter', sans-serif; }
        /* Style the scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(100, 116, 139, 0.5); /* Slate 500 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.3); /* Slate 100 */
        }
    </style>

    <!-- Load React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is required to process the JSX/ES6 in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load Firebase CDNS (V9+ syntax requires specific module imports, V8 style via CDN is more stable here) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Load Lucide Icons CDN for visual appeal -->
    <script src="https://unpkg.com/lucide@latest"></script>

</head>
<body>
    <div id="root">
        <!-- React App mounts here -->
        <div class="flex justify-center items-center h-screen bg-gray-100">
            <div class="text-xl text-gray-600">Loading application...</div>
        </div>
    </div>

    <script type="text/babel">
        // Global variables initialized outside React scope
        let db, auth;
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Firebase Configuration and Initialization ---

        // CORRECTED LINES 46-52:
        // IMPORTANT: The Project ID MUST match the ID where the initial auth token was created.
        const CORRECT_PROJECT_ID = 'deevo-dynasty-app'; 

        // Get the Firebase config from the environment variables (or use a placeholder fallback)
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                // NOTE: This fallback config is based on standard Firebase settings derived from the project ID.
                apiKey: "AIzaSyCXXXXXXXXXXXXXXXXXXXXX", 
                authDomain: CORRECT_PROJECT_ID + ".firebaseapp.com", 
                projectId: CORRECT_PROJECT_ID, 
                storageBucket: CORRECT_PROJECT_ID + ".appspot.com",
                messagingSenderId: "1234567890",
                appId: "1:1234567890:web:abcdef1234567890"
            };
        
        // Use the environment's app ID if available, otherwise use the corrected project ID as a default
        const appId = typeof __app_id !== 'undefined' ? __app_id : CORRECT_PROJECT_ID; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Utility Functions ---

        // Function to create Firebase path for Public or Private data
        const getCollectionPath = (collectionName, isPublic, userId) => {
            if (isPublic) {
                // Public data path: /artifacts/{appId}/public/data/{collectionName}
                return `artifacts/${appId}/public/data/${collectionName}`;
            } else {
                // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}
                if (!userId) {
                    console.error("Cannot build private path: userId is undefined.");
                    return null;
                }
                return `artifacts/${appId}/users/${userId}/${collectionName}`;
            }
        };

        // Icon component using Lucide (assumed available via CDN)
        const Icon = ({ name, size = 24, className = "" }) => {
            const lucide = window.lucide;
            if (!lucide || !lucide[name]) return null;
            const IconComponent = lucide[name];
            return <IconComponent size={size} className={className} />;
        };

        // --- MissionItem Component ---
        const MissionItem = ({ mission, onToggle, onDelete, onEdit, userId }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [newTitle, setNewTitle] = useState(mission.title);
            const [newPoints, setNewPoints] = useState(mission.points);

            // Determine if the current user is the owner (only owner can edit/delete)
            const isOwner = mission.userId === userId;

            const handleSave = async () => {
                if (newTitle.trim() === "" || isNaN(newPoints) || Number(newPoints) <= 0) {
                    // In a real app, this would show a user-facing error modal, not just console log.
                    console.error("Invalid mission data. Title cannot be empty, and points must be a positive number.");
                    setIsEditing(false); // Close editing even on error for simplicity
                    return;
                }
                await onEdit(mission.id, newTitle, Number(newPoints));
                setIsEditing(false);
            };

            const toggleEdit = () => {
                // Reset state when entering edit mode
                if (!isEditing) {
                    setNewTitle(mission.title);
                    setNewPoints(mission.points);
                }
                setIsEditing(!isEditing);
            };

            const pointsDisplay = mission.points === 0 ? "FREE" : `${mission.points}pts`;

            return (
                <div className={`
                    flex items-center p-4 my-2 rounded-xl shadow-lg transition-all duration-300 ease-in-out
                    ${mission.completed ? 'bg-green-100 border-l-8 border-green-600' : 'bg-white border-l-8 border-indigo-600 hover:shadow-xl'}
                `}>
                    <div className="flex-grow min-w-0">
                        {isEditing ? (
                            <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 items-start sm:items-center">
                                <input
                                    type="text"
                                    value={newTitle}
                                    onChange={(e) => setNewTitle(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg w-full sm:flex-1 font-medium text-gray-800"
                                    placeholder="Mission Title"
                                    aria-label="Edit mission title"
                                />
                                <input
                                    type="number"
                                    value={newPoints}
                                    onChange={(e) => setNewPoints(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-lg w-20 text-center text-gray-800"
                                    placeholder="Points"
                                    aria-label="Edit mission points"
                                />
                                <button
                                    onClick={handleSave}
                                    className="p-2 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition-colors whitespace-nowrap"
                                >
                                    <Icon name="Save" size={18} />
                                </button>
                            </div>
                        ) : (
                            <div className="flex items-center">
                                <span className={`
                                    text-lg font-semibold truncate transition-opacity duration-300
                                    ${mission.completed ? 'line-through text-gray-500' : 'text-gray-800'}
                                `}>
                                    {mission.title}
                                </span>
                                <span className={`
                                    ml-4 px-3 py-1 text-xs font-bold rounded-full transition-colors
                                    ${mission.completed 
                                        ? 'bg-green-500 text-white' 
                                        : (mission.isPublic ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-700')
                                    }
                                `}>
                                    {pointsDisplay}
                                </span>
                            </div>
                        )}
                        <p className="text-xs text-gray-500 mt-1">
                            Owner: <span className="font-mono text-sm break-all">{mission.userId}</span>
                        </p>
                    </div>

                    <div className="flex items-center space-x-2 ml-4 flex-shrink-0">
                        {/* Toggle Button */}
                        <button
                            onClick={() => onToggle(mission.id, mission.completed)}
                            className={`
                                p-2 rounded-full shadow-md transition-transform transform hover:scale-105
                                ${mission.completed ? 'bg-gray-300 text-gray-700' : 'bg-indigo-500 text-white hover:bg-indigo-600'}
                            `}
                            title={mission.completed ? "Mark as Incomplete" : "Mark as Complete"}
                        >
                            <Icon name={mission.completed ? "RefreshCw" : "CheckCircle"} size={20} />
                        </button>

                        {/* Edit and Delete Buttons (Only for Owner) */}
                        {isOwner && (
                            <>
                                <button
                                    onClick={toggleEdit}
                                    className="p-2 bg-yellow-400 text-gray-800 rounded-full shadow-md hover:bg-yellow-500 transition-transform transform hover:scale-105"
                                    title="Edit Mission"
                                    disabled={isEditing}
                                >
                                    <Icon name="Edit" size={20} />
                                </button>
                                <button
                                    onClick={() => onDelete(mission.id)}
                                    className="p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition-transform transform hover:scale-105"
                                    title="Delete Mission"
                                    disabled={isEditing}
                                >
                                    <Icon name="Trash2" size={20} />
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // --- AddMissionForm Component ---
        const AddMissionForm = ({ userId, onAdd, isPublic }) => {
            const [title, setTitle] = useState('');
            const [points, setPoints] = useState(100);
            const [errorMessage, setErrorMessage] = useState('');
            const inputRef = useRef(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                setErrorMessage('');

                const pointsNum = Number(points);
                if (title.trim() === '') {
                    setErrorMessage('Mission title is required.');
                    return;
                }
                if (isNaN(pointsNum) || pointsNum < 0) {
                    setErrorMessage('Points must be a non-negative number.');
                    return;
                }

                const newMission = {
                    title: title.trim(),
                    points: pointsNum,
                    completed: false,
                    isPublic: isPublic,
                    userId: userId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                onAdd(newMission);
                setTitle('');
                setPoints(100);
                inputRef.current.focus();
            };

            const isPublicText = isPublic ? "Public Missions" : "Private Missions";

            return (
                <form 
                    onSubmit={handleSubmit} 
                    className="p-6 bg-white rounded-2xl shadow-xl w-full max-w-lg mx-auto mb-6 transition-transform transform hover:scale-[1.01]"
                >
                    <h3 className="text-2xl font-extrabold text-indigo-700 mb-4 border-b pb-2">New {isPublicText}</h3>
                    {errorMessage && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                            <span className="block sm:inline">{errorMessage}</span>
                        </div>
                    )}
                    
                    <div className="flex flex-col space-y-4">
                        <input
                            ref={inputRef}
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            placeholder="Enter new mission description..."
                            className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-lg"
                            aria-label="Mission description"
                        />
                        <div className="flex space-x-4 items-center">
                            <label className="text-gray-600 font-medium whitespace-nowrap">Points:</label>
                            <input
                                type="number"
                                value={points}
                                onChange={(e) => setPoints(e.target.value)}
                                min="0"
                                className="p-3 border border-gray-300 rounded-lg w-24 text-center focus:ring-2 focus:ring-indigo-500"
                                aria-label="Mission points value"
                            />
                            <button
                                type="submit"
                                className="flex-grow p-3 bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition-all duration-200 flex items-center justify-center font-bold text-lg"
                            >
                                <Icon name="PlusCircle" size={20} className="mr-2" />
                                Add Mission
                            </button>
                        </div>
                    </div>
                </form>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [isLoading, setIsLoading] = useState(true);
            const [userId, setUserId] = useState(null);
            const [privateMissions, setPrivateMissions] = useState([]);
            const [publicMissions, setPublicMissions] = useState([]);
            const [error, setError] = useState(null);
            
            // Check if Firebase instances are available
            const isFirebaseReady = typeof firebase !== 'undefined' && typeof firebase.firestore !== 'undefined' && typeof firebase.auth !== 'undefined';

            const missionsRef = useCallback((isPublic) => {
                if (!db || !userId) return null;
                const path = getCollectionPath('missions', isPublic, userId);
                if (!path) return null;
                return db.collection(path);
            }, [userId]);

            // Total Score calculation
            const totalScore = React.useMemo(() => {
                const completedPrivate = privateMissions
                    .filter(m => m.completed)
                    .reduce((sum, m) => sum + m.points, 0);

                const completedPublic = publicMissions
                    .filter(m => m.completed && m.userId === userId) // Only count public missions completed by *this* user
                    .reduce((sum, m) => sum + m.points, 0);

                return completedPrivate + completedPublic;
            }, [privateMissions, publicMissions, userId]);

            // --- Authentication & Initialization Effect ---
            useEffect(() => {
                if (!isFirebaseReady) {
                    console.error("Firebase is not initialized or CDNs failed to load.");
                    setError("System Error: Firebase services failed to load.");
                    return;
                }

                try {
                    // Initialize Firebase App and Services
                    const app = firebase.initializeApp(firebaseConfig);
                    db = app.firestore();
                    auth = app.auth();

                    // Optional: Enable offline persistence (useful for mobile)
                    // db.enablePersistence().catch(err => {
                    //     if (err.code === 'failed-precondition') {
                    //         console.log("Persistence failed: multiple tabs open.");
                    //     } else if (err.code === 'unimplemented') {
                    //         console.log("Persistence not available on this browser.");
                    //     }
                    // });

                    // Set up Auth Listener
                    const unsubscribeAuth = auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            // User is signed in
                            setUserId(user.uid);
                            // Set loading to false only after successful sign-in
                            setIsLoading(false);
                            console.log("User signed in with ID:", user.uid);
                        } else if (initialAuthToken) {
                            // Attempt custom token sign-in
                            try {
                                await auth.signInWithCustomToken(initialAuthToken);
                            } catch (e) {
                                console.error("Error signing in with custom token:", e.message);
                                // Fallback: Sign in anonymously if custom token fails
                                try {
                                    const anonymousUser = await auth.signInAnonymously();
                                    setUserId(anonymousUser.user.uid);
                                    setIsLoading(false);
                                } catch (anonError) {
                                    console.error("Error signing in anonymously:", anonError.message);
                                    setError("Authentication Failed. Check console for details.");
                                    setIsLoading(false); // Stop loading even if it failed
                                }
                            }
                        } else {
                            // Fallback: Sign in anonymously if no token is provided
                            try {
                                const anonymousUser = await auth.signInAnonymously();
                                setUserId(anonymousUser.user.uid);
                                setIsLoading(false);
                            } catch (e) {
                                console.error("Error signing in anonymously:", e.message);
                                setError("Authentication Failed. Check console for details.");
                                setIsLoading(false); // Stop loading even if it failed
                            }
                        }
                    });

                    return () => unsubscribeAuth();
                } catch (e) {
                    console.error("Initialization Error:", e);
                    setError("Fatal Init Error: " + e.message);
                    setIsLoading(false);
                }
            }, [isFirebaseReady]); // Only runs once on mount

            // --- Firestore Data Fetching Effects (Private & Public) ---

            // Private Missions Listener
            useEffect(() => {
                if (!db || !userId) return; // Wait until authenticated
                
                const privateRef = missionsRef(false);
                if (!privateRef) return;

                console.log("Attaching listener to Private Missions for user:", userId);

                const unsubscribe = privateRef
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const missionsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setPrivateMissions(missionsData);
                    }, err => {
                        console.error("Private Missions Fetch Error:", err);
                        // Permission denied is a common rule error.
                        setError("Error fetching private data. Check Firestore rules.");
                    });

                return () => unsubscribe();
            }, [userId, missionsRef]);

            // Public Missions Listener
            useEffect(() => {
                if (!db || !userId) return; // Wait until authenticated

                const publicRef = missionsRef(true);
                if (!publicRef) return;

                console.log("Attaching listener to Public Missions (All Users)");

                // Note: No 'where' clause here to fetch ALL public missions
                const unsubscribe = publicRef
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const missionsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setPublicMissions(missionsData);
                    }, err => {
                        console.error("Public Missions Fetch Error:", err);
                        setError("Error fetching public data. Check Firestore rules.");
                    });

                return () => unsubscribe();
            }, [userId, missionsRef]);


            // --- CRUD Operations ---

            const addMission = async (newMission) => {
                try {
                    if (!userId) {
                        console.error("Cannot add mission: User not authenticated.");
                        return;
                    }
                    const ref = missionsRef(newMission.isPublic);
                    if (ref) {
                        await ref.add(newMission);
                    }
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setError("Could not add mission. Check console.");
                }
            };

            const toggleMission = async (id, isCompleted, isPublic) => {
                try {
                    if (!userId) return;
                    const ref = missionsRef(isPublic);
                    if (ref) {
                        await ref.doc(id).update({
                            completed: !isCompleted,
                            completedAt: !isCompleted ? firebase.firestore.FieldValue.serverTimestamp() : null
                        });
                    }
                } catch (e) {
                    console.error("Error toggling document: ", e);
                    setError("Could not update mission status. Check console.");
                }
            };
            
            const editMission = async (id, title, points, isPublic) => {
                 try {
                    if (!userId) return;
                    const ref = missionsRef(isPublic);
                    if (ref) {
                        await ref.doc(id).update({
                            title: title,
                            points: points,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                } catch (e) {
                    console.error("Error editing document: ", e);
                    setError("Could not edit mission. Check console.");
                }
            };

            const deleteMission = async (id, isPublic) => {
                try {
                    if (!userId) return;
                    const ref = missionsRef(isPublic);
                    if (ref) {
                        await ref.doc(id).delete();
                    }
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setError("Could not delete mission. Check console.");
                }
            };

            // Unified handlers for MissionItem
            const handleToggle = (id, isCompleted) => {
                const targetPrivate = privateMissions.find(m => m.id === id);
                const targetPublic = publicMissions.find(m => m.id === id);
                
                if (targetPrivate) {
                    toggleMission(id, isCompleted, false);
                } else if (targetPublic) {
                    toggleMission(id, isCompleted, true);
                } else {
                    console.error("Mission not found for toggle:", id);
                }
            };

            const handleDelete = (id) => {
                const targetPrivate = privateMissions.find(m => m.id === id);
                const targetPublic = publicMissions.find(m => m.id === id);

                if (targetPrivate && targetPrivate.userId === userId) {
                    // Private mission owned by user
                    deleteMission(id, false);
                } else if (targetPublic && targetPublic.userId === userId) {
                    // Public mission owned by user
                    deleteMission(id, true);
                } else {
                    // In a real app, this would be a user-facing modal
                    console.error("Cannot delete: Mission not found or not owned by user:", id);
                }
            };
            
            const handleEdit = (id, newTitle, newPoints) => {
                 const targetPrivate = privateMissions.find(m => m.id === id);
                 const targetPublic = publicMissions.find(m => m.id === id);
                 
                if (targetPrivate && targetPrivate.userId === userId) {
                    editMission(id, newTitle, newPoints, false);
                } else if (targetPublic && targetPublic.userId === userId) {
                    editMission(id, newTitle, newPoints, true);
                } else {
                    console.error("Cannot edit: Mission not found or not owned by user:", id);
                }
            };

            // --- Rendering ---

            if (isLoading) {
                return (
                    <div className="flex justify-center items-center h-screen bg-gray-50">
                        <div className="flex flex-col items-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
                            <p className="mt-4 text-xl font-semibold text-indigo-700">Connecting to Dynasty Database...</p>
                            <p className="text-sm text-gray-500">Checking authentication token...</p>
                        </div>
                    </div>
                );
            }
            
            if (error) {
                return (
                    <div className="flex justify-center items-center h-screen bg-red-100">
                        <div className="text-center p-8 bg-white rounded-xl shadow-2xl border-t-4 border-red-500">
                            <h2 className="text-2xl font-bold text-red-600 mb-4">Application Error</h2>
                            <p className="text-gray-700">{error}</p>
                            <p className="mt-4 text-sm text-gray-500">Please check the console for detailed error messages.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-8">
                    {/* Header */}
                    <header className="bg-white rounded-3xl shadow-2xl p-6 mb-8 sticky top-0 z-10 transition-all duration-300">
                        <div className="flex flex-col md:flex-row justify-between items-center">
                            <div className="flex items-center space-x-3 mb-4 md:mb-0">
                                <Icon name="BarChart3" size={32} className="text-indigo-600" />
                                <h1 className="text-3xl font-extrabold text-gray-800">
                                    Deevo Dynasty Tracker
                                </h1>
                            </div>
                            <div className="text-center md:text-right">
                                <p className="text-sm font-medium text-gray-600">
                                    Your ID: <span className="font-mono text-base break-all text-indigo-600">{userId}</span>
                                </p>
                                <div className="text-3xl font-bold text-green-600 bg-green-100 px-4 py-2 rounded-xl mt-2 shadow-inner">
                                    SCORE: {totalScore} pts
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    {/* Main Content Area */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        {/* Private Missions Column (Left) */}
                        <div className="space-y-6">
                            <AddMissionForm userId={userId} onAdd={addMission} isPublic={false} />

                            <h2 className="text-3xl font-extrabold text-gray-800 mb-4 border-b pb-2">Your Private Missions</h2>
                            <div className="custom-scrollbar max-h-[70vh] overflow-y-auto pr-2">
                                {privateMissions.length === 0 ? (
                                    <div className="p-6 text-center bg-white rounded-xl shadow-inner text-gray-500">
                                        No private missions yet. Start your quest!
                                    </div>
                                ) : (
                                    privateMissions.map(mission => (
                                        <MissionItem
                                            key={mission.id}
                                            mission={mission}
                                            onToggle={handleToggle}
                                            onDelete={handleDelete}
                                            onEdit={handleEdit}
                                            userId={userId}
                                        />
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Public Missions Column (Right) */}
                        <div className="space-y-6">
                            <AddMissionForm userId={userId} onAdd={addMission} isPublic={true} />
                            
                            <h2 className="text-3xl font-extrabold text-gray-800 mb-4 border-b pb-2">Public Dynasty Missions</h2>
                            <div className="custom-scrollbar max-h-[70vh] overflow-y-auto pr-2">
                                {publicMissions.length === 0 ? (
                                    <div className="p-6 text-center bg-white rounded-xl shadow-inner text-gray-500">
                                        No public missions posted. Be the first!
                                    </div>
                                ) : (
                                    publicMissions.map(mission => (
                                        <MissionItem
                                            key={mission.id}
                                            mission={mission}
                                            onToggle={handleToggle}
                                            onDelete={handleDelete}
                                            onEdit={handleEdit}
                                            userId={userId}
                                        />
                                    ))
                                )}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
