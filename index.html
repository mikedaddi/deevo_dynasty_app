<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deevo Dynasty Code Tracker</title>

    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set default font */
        body { font-family: 'Inter', sans-serif; }
    </style>

    <!-- Load React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel is required to process the JSX/ES6 in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Load Firebase CDNS -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <!-- Load Lucide Icons CDN for visual appeal -->
    <script src="https://unpkg.com/lucide@latest"></script>

</head>
<body>
    <div id="root">
        <!-- React App mounts here -->
        <div class="flex justify-center items-center h-screen bg-gray-100">
            <p class="text-lg text-gray-500">Loading application...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { initializeApp } = firebase;
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth;
        const { getFirestore, doc, setDoc, onSnapshot, collection, query, where, updateDoc } = firebase.firestore;
        const { Bell, CheckSquare, XCircle, ChevronRight, Loader2 } = lucide;

        // Global variables initialized outside React scope
        const firebaseConfig = JSON.parse(__firebase_config);
        // *** REPLACE 'pikaverse-alliance-96839' with YOUR Project ID ***
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'deevo-dynasty-app'; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Set Firebase Logging level
        firebase.firestore.setLogLevel('debug');

        const MISSION_POINTS = 100;
        const MISSION_STATUS = {
            PENDING: 'PENDING',
            COMPLETED: 'COMPLETED',
            FAILED: 'FAILED'
        };

        const initialMissions = [
            { id: 'mission1', title: 'Implement Signal Handling', description: 'Write code to manage two unique user signals.', type: 'core', points: MISSION_POINTS },
            { id: 'mission2', title: 'Secure Data Transmission', description: 'Implement an encryption function for all outgoing data.', type: 'core', points: MISSION_POINTS },
            { id: 'mission3', title: 'Optimize Loop Efficiency', description: 'Refactor a standard `for` loop into a high-performance array method.', type: 'core', points: MISSION_POINTS },
            { id: 'mission4', title: 'Setup CI/CD Pipeline', description: 'Configure an automated build and deployment process.', type: 'side', points: MISSION_POINTS },
            { id: 'mission5', title: 'Automated Testing Suite', description: 'Create and pass 10 unit tests for core functionalities.', type: 'side', points: MISSION_POINTS },
            { id: 'mission6', title: 'Documentation Generation', description: 'Generate comprehensive documentation for all major functions.', type: 'side', points: MISSION_POINTS },
        ];

        const MissionItem = ({ mission, userMissions, userId, dbInstance }) => {
            const status = userMissions[mission.id]?.status || MISSION_STATUS.PENDING;

            const handleUpdateStatus = async (newStatus) => {
                if (!userId || !dbInstance) return console.error("Database not ready.");

                const missionRef = doc(dbInstance, 'artifacts', appId, 'users', userId, 'missions', mission.id);

                try {
                    await setDoc(missionRef, {
                        status: newStatus,
                        timestamp: new Date(),
                        points: newStatus === MISSION_STATUS.COMPLETED ? mission.points : 0
                    }, { merge: true });

                } catch (error) {
                    console.error("Error updating mission status:", error);
                }
            };

            const getIcon = (status) => {
                switch (status) {
                    case MISSION_STATUS.COMPLETED:
                        return <CheckSquare className="w-5 h-5 text-green-500" />;
                    case MISSION_STATUS.FAILED:
                        return <XCircle className="w-5 h-5 text-red-500" />;
                    default:
                        return <ChevronRight className="w-5 h-5 text-gray-400" />;
                }
            };

            const isCompleted = status === MISSION_STATUS.COMPLETED;
            const isFailed = status === MISSION_STATUS.FAILED;

            return (
                <div className={`p-4 border-b last:border-b-0 flex flex-col sm:flex-row justify-between items-start sm:items-center transition duration-200 
                                ${isCompleted ? 'bg-green-50 border-green-200' : isFailed ? 'bg-red-50 border-red-200' : 'hover:bg-gray-50'}`}>
                    
                    <div className="flex-1 min-w-0 mb-3 sm:mb-0">
                        <h3 className={`text-lg font-semibold truncate ${isCompleted ? 'text-green-700' : isFailed ? 'text-red-700' : 'text-gray-800'}`}>
                            {getIcon(status)} {mission.title}
                        </h3>
                        <p className="text-sm text-gray-500 mt-1 pl-6">{mission.description}</p>
                        <span className="inline-block mt-2 ml-6 text-xs font-medium px-2.5 py-0.5 rounded-full 
                                        bg-indigo-100 text-indigo-800 uppercase">{mission.type} Mission</span>
                    </div>

                    <div className="flex space-x-2 text-sm font-medium">
                        <span className={`px-3 py-1 rounded-lg ${isCompleted ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-800'}`}>
                            {isCompleted ? 'Completed' : isFailed ? 'Failed' : 'Pending'}
                        </span>
                        <span className="px-3 py-1 rounded-lg bg-yellow-400 text-gray-900">
                            {mission.points} Pts
                        </span>
                    </div>

                    <div className="flex space-x-2 mt-3 sm:mt-0 sm:ml-4">
                        <button 
                            onClick={() => handleUpdateStatus(MISSION_STATUS.COMPLETED)}
                            disabled={isCompleted}
                            className={`px-4 py-2 rounded-lg text-white font-medium transition duration-200 
                                        ${isCompleted ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 active:bg-green-700'} 
                                        disabled:opacity-50`}
                        >
                            Done
                        </button>
                        <button 
                            onClick={() => handleUpdateStatus(MISSION_STATUS.FAILED)}
                            disabled={isCompleted || isFailed}
                            className={`px-4 py-2 rounded-lg text-white font-medium transition duration-200 
                                        ${isCompleted || isFailed ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-500 hover:bg-red-600 active:bg-red-700'} 
                                        disabled:opacity-50`}
                        >
                            Fail
                        </button>
                    </div>
                </div>
            );
        };

        const calculateTotalScore = (userMissions) => {
            // FIX: If userMissions is empty or null, return 0 instead of crashing.
            if (!userMissions || Object.keys(userMissions).length === 0) {
                return 0; 
            }

            return initialMissions.reduce((total, mission) => {
                const userStatus = userMissions[mission.id]?.status;
                if (userStatus === MISSION_STATUS.COMPLETED) {
                    return total + mission.points;
                }
                return total;
            }, 0);
        };

        const App = () => {
            const [dbInstance, setDbInstance] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userMissions, setUserMissions] = useState({});
            const [isLoading, setIsLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('all');

            // 1. Firebase Initialization and Authentication
            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        // Authentication
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        
                        // Auth State Listener
                        const unsubscribe = onAuthStateChanged(auth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                                setDbInstance(db);
                            } else {
                                console.warn("User not authenticated after sign-in attempt.");
                                setUserId(null);
                                setDbInstance(null);
                                setIsLoading(false);
                            }
                        });
                        return () => unsubscribe();

                    } catch (error) {
                        console.error("Firebase Initialization or Auth Error:", error);
                        setIsLoading(false);
                    }
                };

                initializeFirebase();
            }, []);

            // 2. Data Subscription (onSnapshot)
            useEffect(() => {
                if (!dbInstance || !userId) {
                    if (userId === null) setIsLoading(false); // If auth failed, stop loading
                    return;
                }

                const userMissionsRef = collection(dbInstance, 'artifacts', appId, 'users', userId, 'missions');

                // This query fetches ALL mission status documents for the current user
                const unsubscribe = onSnapshot(userMissionsRef, (snapshot) => {
                    const missionsData = {};
                    snapshot.forEach((doc) => {
                        missionsData[doc.id] = doc.data();
                    });
                    setUserMissions(missionsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [dbInstance, userId]);

            // Derived State
            const filteredMissions = useMemo(() => {
                if (activeTab === 'core') {
                    return initialMissions.filter(m => m.type === 'core');
                }
                if (activeTab === 'side') {
                    return initialMissions.filter(m => m.type === 'side');
                }
                return initialMissions;
            }, [activeTab]);

            const totalScore = useMemo(() => calculateTotalScore(userMissions), [userMissions]);

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <Loader2 className="w-8 h-8 animate-spin text-indigo-600" />
                        <p className="ml-3 text-lg font-medium text-indigo-600">Initializing Deevo Core...</p>
                    </div>
                );
            }
            
            // Fallback for unauthorized/failed auth state
            if (!userId) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-red-50 p-4">
                        <XCircle className="w-12 h-12 text-red-500 mb-4" />
                        <h1 className="text-xl font-bold text-red-800 mb-2">Authentication Failed</h1>
                        <p className="text-gray-600 text-center">Could not establish a secure connection. Please refresh the page.</p>
                    </div>
                );
            }

            const tabClasses = (tabName) => 
                `px-4 py-2 font-medium border-b-2 transition duration-150 ease-in-out ${
                    activeTab === tabName 
                        ? 'border-indigo-500 text-indigo-600 bg-indigo-50' 
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`;

            return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-8">
                    
                    {/* Header and Score Card */}
                    <header className="mb-8">
                        <div className="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 flex flex-col sm:flex-row justify-between items-center border-t-4 border-indigo-500">
                            <div className="flex items-center mb-4 sm:mb-0">
                                <Bell className="w-8 h-8 text-indigo-500 mr-3" />
                                <h1 className="text-2xl font-extrabold text-gray-800">DEEVO DYNASTY CODE TRACKER:</h1>
                            </div>
                            
                            <div className="flex items-center">
                                <span className="text-4xl font-black text-indigo-600 tracking-wider">
                                    {totalScore}
                                </span>
                                <span className="text-xl font-medium text-gray-600 ml-2">
                                    Points
                                </span>
                            </div>
                        </div>
                    </header>

                    {/* Tab Navigation */}
                    <nav className="max-w-4xl mx-auto bg-white shadow-md rounded-t-lg border-b border-gray-200">
                        <div className="flex justify-start">
                            <button onClick={() => setActiveTab('all')} className={tabClasses('all')}>All Missions</button>
                            <button onClick={() => setActiveTab('core')} className={tabClasses('core')}>Core</button>
                            <button onClick={() => setActiveTab('side')} className={tabClasses('side')}>Side Quests</button>
                        </div>
                    </nav>

                    {/* Mission List */}
                    <main className="max-w-4xl mx-auto bg-white shadow-xl rounded-b-xl mb-12">
                        {filteredMissions.map(mission => (
                            <MissionItem
                                key={mission.id}
                                mission={mission}
                                userMissions={userMissions}
                                userId={userId}
                                dbInstance={dbInstance}
                            />
                        ))}
                    </main>
                    
                    {/* User ID Footer (for collaboration) */}
                    <footer className="max-w-4xl mx-auto text-center text-xs text-gray-500 mt-4 p-4">
                        <p>
                            Securely signed in as User ID (for collaboration): <span className="font-mono bg-gray-200 p-1 rounded-md text-gray-700 select-all">{userId}</span>
                        </p>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

